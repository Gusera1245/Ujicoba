<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Saya - TalkSphere</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .profile-card {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }
        .info-item {
            border-bottom: 1px solid #e5e7eb;
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .uid-display {
            word-break: break-all;
            font-family: monospace;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation (Sama seperti discussion.html) -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index(5).html" class="flex items-center">
                        <i data-feather="message-square" class="h-6 w-6 text-indigo-600 mr-2"></i>
                        <span class="text-xl font-bold text-indigo-600">TalkSphere</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="discussion.html" class="text-gray-600 hover:text-indigo-600 font-medium">Diskusi</a>
                    <a href="profile.html" class="text-indigo-600 font-medium">Profil</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content: Profile Card -->
    <div class="max-w-xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="profile-card bg-white rounded-xl overflow-hidden mt-10">
            <div class="bg-indigo-600 h-24 relative">
                <img id="profile-avatar" class="w-24 h-24 rounded-full border-4 border-white absolute -bottom-12 left-1/2 transform -translate-x-1/2 object-cover" 
                     src="https://placehold.co/150x150/A8A29E/ffffff?text=U" alt="Profile Avatar"
                     onerror="this.onerror=null; this.src='https://placehold.co/150x150/4F46E5/ffffff?text=U'">
            </div>
            
            <div class="pt-16 p-6 text-center">
                <h1 id="user-display-name" class="text-2xl font-bold text-gray-800">Memuat Nama...</h1>
                <p id="auth-status" class="text-sm text-gray-500 mt-1 mb-6">Status: <span id="auth-status-text" class="font-medium text-red-500">Memeriksa...</span></p>

                <!-- Pesan Status & Error -->
                <div id="update-status-message" class="p-3 mb-4 rounded-lg text-sm text-center hidden"></div>

                <div class="text-left mt-8 border border-gray-200 rounded-lg divide-y divide-gray-200">
                    <div class="info-item p-4">
                        <p class="text-sm font-semibold text-gray-600">User ID (UID):</p>
                        <p id="user-uid" class="uid-display text-gray-800 mt-1">N/A</p>
                    </div>
                    <div class="info-item p-4">
                        <p class="text-sm font-semibold text-gray-600">Tipe Akun:</p>
                        <p id="user-account-type" class="text-gray-800 mt-1">N/A</p>
                    </div>
                    <div class="info-item p-4">
                        <p class="text-sm font-semibold text-gray-600">Email (Jika ada):</p>
                        <p id="user-email" class="text-gray-800 mt-1">N/A</p>
                    </div>
                </div>
                
                <!-- Tombol Edit Profil -->
                <button id="toggle-edit-form" class="mt-6 w-full bg-indigo-500 text-white py-2.5 rounded-lg font-semibold hover:bg-indigo-600 transition disabled:opacity-50" disabled>
                    <i data-feather="edit-3" class="h-5 w-5 mr-2 inline-block"></i> Edit Profil
                </button>

                <!-- Formulir Edit Profil (Awalnya Tersembunyi) -->
                <form id="edit-profile-form" class="mt-6 space-y-4 bg-gray-100 p-5 rounded-lg border border-gray-200 hidden">
                    <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">Ubah Detail Profil</h3>

                    <div>
                        <label for="edit-display-name" class="block text-sm font-medium text-gray-700 text-left">Nama Tampilan</label>
                        <input type="text" id="edit-display-name" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Masukkan Nama Anda">
                    </div>

                    <div>
                        <label for="edit-photo-url" class="block text-sm font-medium text-gray-700 text-left">URL Foto Profil (Opsional)</label>
                        <input type="url" id="edit-photo-url" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://contoh.com/avatar.jpg">
                    </div>

                    <button type="submit" id="save-profile-button" class="w-full bg-green-600 text-white py-2.5 rounded-lg font-semibold hover:bg-green-700 transition duration-300 disabled:opacity-50">
                        Simpan Perubahan
                    </button>
                    <button type="button" id="cancel-edit-button" class="w-full bg-gray-300 text-gray-700 py-2.5 rounded-lg font-semibold hover:bg-gray-400 transition duration-300">
                        Batal
                    </button>
                </form>

                <div class="mt-8 space-y-3">
                    <a id="login-link" href="login.html" class="block w-full bg-indigo-600 text-white py-2.5 rounded-lg font-semibold hover:bg-indigo-700 transition hidden">
                        Masuk / Daftar Akun
                    </a>
                    <button id="logout-button" class="w-full bg-gray-200 text-gray-700 py-2.5 rounded-lg font-semibold hover:bg-gray-300 transition" disabled>
                        Logout
                    </button>
                    <p id="logout-message" class="text-xs text-red-500 mt-2 hidden">Logout berhasil. Silakan refresh halaman untuk login otomatis lagi.</p>
                </div>
            </div>
        </div>

        <div id="not-logged-in-message" class="text-center p-8 bg-white rounded-xl mt-8 shadow-sm hidden">
            <i data-feather="alert-triangle" class="h-8 w-8 text-yellow-500 mx-auto mb-3"></i>
            <p class="text-gray-700 font-medium">Anda belum login.</p>
            <p class="text-sm text-gray-500 mt-1">Gunakan tombol di atas untuk Masuk atau Daftar.</p>
        </div>
    </div>

    <!-- Footer (Sama seperti discussion.html) -->
    <footer class="bg-white border-t border-gray-200 mt-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center text-sm text-gray-500">
            &copy; 2023 TalkSphere. All rights reserved.
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        feather.replace();

        // ------------------------------------------------------------------
        // FIREBASE CONFIGURATION (Mengambil dari variabel global Canvas)
        // ------------------------------------------------------------------
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let firebaseConfig = null;
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.error("Gagal memparsing konfigurasi Firebase:", e);
        }

        let auth;
        let currentUser = null; // Menyimpan objek user saat ini

        if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
        } else {
            console.error("Firebase tidak diinisialisasi: Konfigurasi tidak ditemukan atau tidak valid.");
            auth = { onAuthStateChanged: (cb) => cb(null), currentUser: null }; 
        }

        // --- ELEMEN UI ---
        const logoutButton = document.getElementById('logout-button');
        const loginLink = document.getElementById('login-link');
        const logoutMessage = document.getElementById('logout-message');
        const toggleEditButton = document.getElementById('toggle-edit-form');
        const editForm = document.getElementById('edit-profile-form');
        const displayNameInput = document.getElementById('edit-display-name');
        const photoUrlInput = document.getElementById('edit-photo-url');
        const saveButton = document.getElementById('save-profile-button');
        const cancelButton = document.getElementById('cancel-edit-button');
        const statusMessageEl = document.getElementById('update-status-message');


        // --- UTILITY ---
        function showStatus(message, isError = false) {
            statusMessageEl.textContent = message;
            statusMessageEl.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (isError) {
                statusMessageEl.classList.add('bg-red-100', 'text-red-700');
            } else {
                statusMessageEl.classList.add('bg-green-100', 'text-green-700');
            }
        }
        
        function hideStatus() {
             statusMessageEl.classList.add('hidden');
        }

        // --- FUNGSI LOGOUT ---
        async function handleLogout() {
            hideStatus();
            logoutButton.disabled = true;
            logoutButton.textContent = "Sedang Logout...";
            try {
                await signOut(auth);
                logoutMessage.classList.remove('hidden');
                logoutButton.classList.add('hidden');
                loginLink.classList.remove('hidden');
                editForm.classList.add('hidden');
                toggleEditButton.disabled = true;
                updateProfileUI(null);
                
            } catch (error) {
                console.error("Error saat logout:", error);
                logoutButton.disabled = false;
                logoutButton.textContent = "Gagal Logout";
                showStatus("Gagal Logout: " + error.message, true);
            }
        }

        // --- FUNGSI UPDATE UI BERDASARKAN STATUS USER ---
        function updateProfileUI(user) {
            const displayNameEl = document.getElementById('user-display-name');
            const uidEl = document.getElementById('user-uid');
            const typeEl = document.getElementById('user-account-type');
            const emailEl = document.getElementById('user-email');
            const statusTextEl = document.getElementById('auth-status-text');
            const avatarEl = document.getElementById('profile-avatar');
            
            currentUser = user; // Update state global user

            if (user) {
                // PENGGUNA MASUK
                const userName = user.displayName || (user.isAnonymous ? `Tamu Unik (${user.uid.substring(0, 5)})` : `User-${user.uid.substring(0, 5)}`);
                const userInitial = userName[0].toUpperCase();
                const userAvatar = user.photoURL || `https://placehold.co/150x150/4F46E5/ffffff?text=${userInitial}`;

                displayNameEl.textContent = userName;
                uidEl.textContent = user.uid;
                typeEl.textContent = user.email ? 'Permanen (Email/Password)' : 'Kustom (Token/Anonim)';
                emailEl.textContent = user.email || 'N/A';
                statusTextEl.textContent = 'Terautentikasi';
                statusTextEl.classList.remove('text-red-500');
                statusTextEl.classList.add('text-green-600');
                avatarEl.src = userAvatar;
                
                // Isi formulir edit dengan data saat ini
                displayNameInput.value = user.displayName || '';
                photoUrlInput.value = user.photoURL || '';

                logoutButton.disabled = false;
                toggleEditButton.disabled = false;
                logoutButton.classList.remove('hidden');
                loginLink.classList.add('hidden');
                document.getElementById('not-logged-in-message').classList.add('hidden');
                
            } else {
                // PENGGUNA TIDAK MASUK
                displayNameEl.textContent = 'Tamu';
                uidEl.textContent = 'N/A';
                typeEl.textContent = 'Tidak Masuk';
                emailEl.textContent = 'N/A';
                statusTextEl.textContent = 'Tidak Terautentikasi';
                statusTextEl.classList.remove('text-green-600');
                statusTextEl.classList.add('text-red-500');
                avatarEl.src = 'https://placehold.co/150x150/A8A29E/ffffff?text=T';

                logoutButton.disabled = true;
                toggleEditButton.disabled = true;
                logoutButton.classList.add('hidden');
                loginLink.classList.remove('hidden');
                document.getElementById('not-logged-in-message').classList.remove('hidden');
            }
        }
        
        // --- FUNGSI EDIT PROFIL ---
        async function handleEditProfile(e) {
            e.preventDefault();
            hideStatus();
            
            if (!currentUser) {
                showStatus("Anda harus login untuk mengedit profil.", true);
                return;
            }

            const newDisplayName = displayNameInput.value.trim();
            const newPhotoURL = photoUrlInput.value.trim();

            if (!newDisplayName && !newPhotoURL) {
                 showStatus("Setidaknya satu bidang (Nama atau URL Foto) harus diisi.", true);
                 return;
            }
            
            saveButton.disabled = true;
            saveButton.textContent = "Menyimpan...";
            
            try {
                // Hati-hati: Firebase mungkin menolak URL foto yang tidak valid
                const updates = {};
                if (newDisplayName) updates.displayName = newDisplayName;
                if (newPhotoURL) updates.photoURL = newPhotoURL;
                if (!newPhotoURL) updates.photoURL = null; // Izinkan penghapusan URL foto

                await updateProfile(currentUser, updates);
                
                showStatus("Profil berhasil diperbarui!", false);
                
                // Otomatis tutup form dan update UI
                editForm.classList.add('hidden');
                updateProfileUI(auth.currentUser); // Memaksa update UI dengan data terbaru
                
            } catch (error) {
                console.error("Gagal mengupdate profil:", error);
                showStatus("Gagal mengupdate profil: " + error.message, true);
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = "Simpan Perubahan";
            }
        }

        // --- LISTENER UI ---
        toggleEditButton.addEventListener('click', () => {
            editForm.classList.toggle('hidden');
            hideStatus();
            // Isi form dengan data yang ada saat ini
            if (currentUser) {
                displayNameInput.value = currentUser.displayName || '';
                photoUrlInput.value = currentUser.photoURL || '';
            }
        });
        
        cancelButton.addEventListener('click', () => {
             editForm.classList.add('hidden');
             hideStatus();
        });
        
        editForm.addEventListener('submit', handleEditProfile);


        // --- TITIK MASUK UTAMA ---
        async function setupAuthAndInitialize() {
            if (!auth) {
                 updateProfileUI(null);
                 return;
            }
            
            // 1. Coba Sign-in dengan token kustom jika ada
            if (initialAuthToken && !auth.currentUser) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.warn(`Custom token sign-in failed. Error: ${error.message}`);
                }
            }
            
            // 2. Listener untuk memantau status autentikasi dan mengupdate UI
            onAuthStateChanged(auth, function(user) {
                updateProfileUI(user);
                
                if (user) {
                    // Hanya tambahkan event listener sekali setelah login
                    logoutButton.removeEventListener('click', handleLogout); 
                    logoutButton.addEventListener('click', handleLogout);
                }
            });
        }

        if (auth) {
            setupAuthAndInitialize();
        }
    </script>
</body>
</html>

