<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discussion Page (Login Wajib) - TalkSphere</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .discussion-header {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('http://static.photos/technology/1200x630/1');
            background-size: cover;
            background-position: center;
        }
        .comment-box {
            transition: all 0.3s ease;
        }
        .comment-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        #comments-list {
            max-height: 800px;
            overflow-y: auto;
        }
        #comments-list::-webkit-scrollbar {
            width: 6px;
        }
        #comments-list::-webkit-scrollbar-thumb {
            background-color: #a8a8a8;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index(5).html" class="flex items-center">
                        <i data-feather="message-square" class="h-6 w-6 text-indigo-600 mr-2"></i>
                        <span class="text-xl font-bold text-indigo-600">TalkSphere</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Tombol Notifikasi -->
                    <button id="notification-bell" class="text-gray-600 hover:text-indigo-600 relative">
                        <i data-feather="bell" class="h-6 w-6"></i>
                        <span id="notif-badge" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full hidden">0</span>
                    </button>
                    <a href="profile.html" class="flex items-center space-x-2">
                        <img id="user-avatar-nav" class="h-8 w-8 rounded-full object-cover" src="https://placehold.co/100x100/A8A29E/ffffff?text=U" alt="User Avatar">
                        <span id="user-name-nav" class="hidden sm:inline text-sm font-medium text-gray-700">Memuat...</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Discussion Header -->
    <header class="discussion-header py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-white">
            <span class="inline-block bg-indigo-600 text-xs font-semibold px-3 py-1 rounded-full mb-3">#Teknologi</span>
            <h1 class="text-4xl md:text-5xl font-extrabold mb-4 leading-tight">Mengeksplorasi Masa Depan Kecerdasan Buatan dan Etikanya</h1>
            <p class="text-gray-300 text-lg mb-4">Sebuah diskusi mendalam mengenai potensi tak terbatas AI dan tantangan moral yang menyertainya.</p>
            <div class="flex items-center text-sm">
                <p class="mr-4">Dibuat oleh: <span id="author-uid" data-uid="USER_ID_JANE_DOE" class="font-medium text-indigo-300">Jane Doe</span></p> 
                <p><span id="total-comments">0</span> Komentar | 120 Views</p>
            </div>
        </div>
    </header>

    <!-- Main Content and Sidebar -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:flex md:space-x-8">
        <!-- Kolom Utama (Konten Diskusi) -->
        <main class="w-full md:w-2/3 mb-8 md:mb-0">
            
            <!-- Deskripsi Diskusi (dibuat statis) -->
            <section class="bg-white p-6 rounded-lg shadow-lg mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Latar Belakang</h2>
                <p class="text-gray-700 leading-relaxed mb-4">
                    Kecerdasan Buatan (AI) telah melampaui batas-batas fiksi ilmiah dan menjadi bagian integral dari kehidupan sehari-hari kita. Mulai dari algoritma rekomendasi hingga sistem penggerak otonom, dampaknya tidak terhindarkan. Namun, seiring dengan kemajuan ini, timbul pertanyaan etika yang mendalam: Bagaimana kita memastikan AI beroperasi secara adil? Apa implikasi pekerjaan? Dan yang paling penting, bagaimana kita menjaga kontrol?
                </p>
                <p class="text-gray-700 leading-relaxed">
                    Kami mengundang Anda untuk berbagi pandangan, studi kasus, atau solusi inovatif Anda mengenai bagaimana kita dapat menyeimbangkan inovasi AI dengan tanggung jawab moral.
                </p>
            </section>
            
            <!-- Tombol Interaksi (Like) -->
            <div class="flex flex-wrap gap-3 space-x-0 mb-8">
                <button id="scroll-to-comment" class="flex items-center bg-indigo-600 text-white px-4 py-2 rounded-full font-medium hover:bg-indigo-700 transition duration-300">
                    <i data-feather="message-circle" class="h-5 w-5 mr-2"></i> Tambahkan Komentar
                </button>
                <button class="flex items-center bg-gray-200 text-gray-700 px-4 py-2 rounded-full font-medium hover:bg-gray-300 transition duration-300">
                    <i data-feather="bookmark" class="h-5 w-5 mr-2"></i> Simpan
                </button>
                <button id="like-button" class="flex items-center text-gray-700 hover:text-indigo-600 transition duration-300" disabled>
                    <i data-feather="heart" class="h-5 w-5 mr-2"></i> 
                    <span id="like-count">0</span> Likes
                </button>
            </div>

            <!-- Bagian Komentar Dinamis -->
            <section id="comment-section">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Komentar (<span id="comment-count-display">0</span>)</h2>
                
                <!-- Formulir Komentar Baru -->
                <div class="bg-white p-6 rounded-lg shadow-lg mb-8" id="comment-form-container">
                    <p class="font-semibold mb-3">Tinggalkan Komentar Anda:</p>
                    <textarea id="comment-text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none" rows="3" placeholder="Tulis komentar yang membangun di sini..." disabled></textarea>
                    
                    <div id="auth-status-message" class="mt-3 text-sm flex items-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-indigo-600 mr-2"></div>
                        <span class="text-gray-600">Memeriksa status login...</span>
                    </div>

                    <button id="submit-comment" class="mt-3 bg-indigo-600 text-white px-5 py-2 rounded-lg font-medium hover:bg-indigo-700 transition duration-300 disabled:opacity-50" disabled>
                        Kirim Komentar
                    </button>
                    <p id="comment-error" class="text-sm text-red-500 mt-2 hidden"></p>
                </div>

                <!-- Kontainer Komentar Dinamis -->
                <div id="comments-list" class="space-y-4">
                    <!-- Komentar akan dirender di sini secara dinamis oleh JavaScript -->
                    <div id="loading-comments" class="text-center text-gray-500 p-8">
                         <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-2"></div>
                         Memuat Komentar...
                    </div>
                </div>

            </section>
        </main>

        <!-- Kolom Samping (Sidebar) - Statis -->
        <aside class="w-full md:w-1/3">
            <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Ringkasan Diskusi</h3>
                <ul class="space-y-3 text-gray-700 text-sm">
                    <li class="flex items-center justify-between">
                        <span class="flex items-center"><i data-feather="calendar" class="h-4 w-4 mr-2 text-indigo-500"></i> Tanggal Mulai:</span>
                        <span class="font-medium">15 Okt 2025</span>
                    </li>
                    <li class="flex items-center justify-between">
                        <span class="flex items-center"><i data-feather="clock" class="h-4 w-4 mr-2 text-indigo-500"></i> Durasi:</span>
                        <span class="font-medium">1 Minggu</span>
                    </li>
                    <li class="flex items-center justify-between">
                        <span class="flex items-center"><i data-feather="users" class="h-4 w-4 mr-2 text-indigo-500"></i> Tingkat:</span>
                        <span class="font-medium bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs">Menengah</span>
                    </li>
                    <li class="flex items-center justify-between">
                        <span class="flex items-center"><i data-feather="tag" class="h-4 w-4 mr-2 text-indigo-500"></i> Topik:</span>
                        <span class="font-medium">AI, Etika, Masa Depan</span>
                    </li>
                </ul>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Peserta Aktif (6/20)</h3>
                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <div class="text-center">
                        <img src="http://static.photos/people/200x200/1" alt="Participant" class="w-12 h-12 rounded-full mx-auto mb-2 object-cover">
                        <p class="text-xs text-gray-700 truncate">User 1</p>
                    </div>
                    <div class="text-center">
                        <img src="http://static.photos/people/200x200/2" alt="Participant" class="w-12 h-12 rounded-full mx-auto mb-2 object-cover">
                        <p class="text-xs text-gray-700 truncate">Sarah J.</p>
                    </div>
                    <div class="text-center">
                        <img src="http://static.photos/people/200x200/3" alt="Participant" class="w-12 h-12 rounded-full mx-auto mb-2 object-cover">
                        <p class="text-xs text-gray-700 truncate">Michael R.</p>
                    </div>
                    <div class="text-center">
                        <img src="http://static.photos/people/200x200/4" alt="Participant" class="w-12 h-12 rounded-full mx-auto mb-2 object-cover">
                        <p class="text-xs text-gray-700 truncate">Emma D.</p>
                    </div>
                    <div class="text-center">
                        <img src="http://static.photos/people/200x200/5" alt="Participant" class="w-12 h-12 rounded-full mx-auto mb-2 object-cover">
                        <p class="text-xs text-gray-700 truncate">David K.</p>
                    </div>
                    <div class="text-center">
                        <div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full mx-auto mb-2 flex items-center justify-center font-bold text-sm">
                            +14
                        </div>
                        <p class="text-xs text-gray-700 truncate">Lainnya</p>
                    </div>
                </div>
                <button class="w-full bg-indigo-100 text-indigo-600 py-2 rounded-lg mt-4 text-sm font-medium hover:bg-indigo-200 transition duration-300">
                    Gabung Diskusi
                </button>
            </div>
            
        </aside>
    </div>

    <!-- Footer (Responsif) -->
    <footer class="bg-white border-t border-gray-200 mt-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center text-sm text-gray-500">
            &copy; 2023 TalkSphere. All rights reserved.
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, runTransaction, setDoc, updateDoc, FieldValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        feather.replace();

        // ------------------------------------------------------------------
        // FIREBASE CONFIGURATION (Mengambil dari variabel global Canvas)
        // ------------------------------------------------------------------
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = null;
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.error("Gagal memparsing konfigurasi Firebase:", e);
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let auth;
        let db;

        if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app); 
        } else {
            console.error("Firebase tidak diinisialisasi: Konfigurasi tidak ditemukan atau tidak valid.");
        }

        // --- KONSTANTA & ELEMEN UI ---
        const DISCUSSION_ID = "mengeksplorasi_ai_dan_etika";
        const likeButton = document.getElementById('like-button');
        const submitCommentButton = document.getElementById('submit-comment');
        const commentTextInput = document.getElementById('comment-text');
        const authStatusMessage = document.getElementById('auth-status-message');
        const commentsList = document.getElementById('comments-list');
        const likeCountSpan = document.getElementById('like-count');
        const commentCountDisplay = document.getElementById('comment-count-display');
        const totalCommentsHeader = document.getElementById('total-comments');

        let currentUser = null; 
        
        // Utility untuk format waktu
        function timeAgo(timestamp) {
            if (timestamp && typeof timestamp.toDate === 'function') {
                const now = Date.now();
                const past = timestamp.toDate().getTime();
                const seconds = Math.floor((now - past) / 1000);

                if (seconds < 60) return `${seconds} detik yang lalu`;
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `${minutes} menit yang lalu`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours} jam yang lalu`;
                const days = Math.floor(hours / 24);
                if (days < 7) return `${days} hari yang lalu`;
                
                return new Date(past).toLocaleDateString('id-ID', {
                    day: 'numeric', month: 'short', year: 'numeric'
                });
            }
            return 'Waktu tidak tersedia';
        }
        
        // --- FUNGSI LIKE/BATAL LIKE ---
        function toggleLike() {
            if (!currentUser) {
                console.warn("User not authenticated. Cannot perform like action. Redirecting to login.");
                document.getElementById('comment-error').textContent = "Anda harus login untuk interaksi. Mengarahkan ke halaman login...";
                document.getElementById('comment-error').classList.remove('hidden');
                setTimeout(() => { window.location.href = 'login.html'; }, 1000);
                return;
            }
            
            const discussionRef = doc(db, 'artifacts', appId, 'public', 'data', 'discussions', DISCUSSION_ID);
            const userId = currentUser.uid;

             runTransaction(db, async (transaction) => {
                const docSnapshot = await transaction.get(discussionRef);
                if (!docSnapshot.exists()) { 
                    throw new Error("Dokumen Diskusi tidak ditemukan."); 
                }

                const data = docSnapshot.data();
                const likedBy = data.likedBy || [];
                const isLiked = likedBy.includes(userId);
                let newCount = data.likesCount || 0;
                let newLikedBy = [...likedBy];

                if (isLiked) {
                    newLikedBy = likedBy.filter(uid => uid !== userId);
                    newCount = Math.max(0, newCount - 1);
                } else {
                    newLikedBy.push(userId);
                    newCount++;
                }

                transaction.update(discussionRef, { 
                    likesCount: newCount, 
                    likedBy: newLikedBy 
                });
                return { newCount, isLiked: !isLiked };

            }).then(({ newCount, isLiked }) => {
                likeCountSpan.textContent = newCount;
                if (isLiked) {
                    likeButton.classList.remove('text-gray-700'); 
                    likeButton.classList.add('text-red-500'); 
                } else {
                    likeButton.classList.remove('text-red-500');
                    likeButton.classList.add('text-gray-700'); 
                }
                
            }).catch((error) => {
                console.error("Gagal menjalankan transaksi Like:", error.message);
                document.getElementById('comment-error').textContent = "Gagal memproses Like. Cek console untuk detail.";
                document.getElementById('comment-error').classList.remove('hidden');
            });
        }

        // --- FUNGSI MENGIRIM KOMENTAR BARU ---
        async function submitComment(event) {
            event.preventDefault();
            const text = commentTextInput.value.trim();
            
            if (!currentUser) {
                document.getElementById('comment-error').textContent = "Anda harus login untuk berkomentar. Mengarahkan ke halaman login...";
                document.getElementById('comment-error').classList.remove('hidden');
                 setTimeout(() => { window.location.href = 'login.html'; }, 1000);
                return;
            }
            if (text.length === 0) {
                document.getElementById('comment-error').textContent = "Komentar tidak boleh kosong.";
                document.getElementById('comment-error').classList.remove('hidden');
                return;
            }
            document.getElementById('comment-error').classList.add('hidden');

            submitCommentButton.disabled = true;
            submitCommentButton.textContent = "Mengirim...";

            try {
                const commentsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'discussions', DISCUSSION_ID, 'comments');

                await addDoc(commentsCollectionRef, {
                    userId: currentUser.uid,
                    userName: currentUser.displayName || `User-${currentUser.uid.substring(0, 5)}`, 
                    userAvatar: currentUser.photoURL || `https://placehold.co/100x100/4F46E5/ffffff?text=${currentUser.displayName ? currentUser.displayName[0] : 'U'}`,
                    text: text,
                    createdAt: serverTimestamp(),
                    repliesCount: 0,
                    likesCount: 0,
                    isDeleted: false
                });

                commentTextInput.value = '';
                submitCommentButton.textContent = "Kirim Komentar";
            } catch (error) {
                console.error("Error saat mengirim komentar:", error);
                document.getElementById('comment-error').textContent = "Gagal mengirim komentar: " + error.message;
                document.getElementById('comment-error').classList.remove('hidden');
                submitCommentButton.textContent = "Kirim Komentar";
            } finally {
                if (currentUser) {
                    submitCommentButton.disabled = false;
                }
            }
        }
        
        // --- FUNGSI MERENDER KOMENTAR dan HAPUS ---
        function renderComment(commentData, docId) {
            if (commentData.isDeleted) return null; 

            const timeString = timeAgo(commentData.createdAt);
            const userInitial = commentData.userName ? commentData.userName[0] : 'U';
            const avatarUrl = commentData.userAvatar || `https://placehold.co/100x100/4F46E5/ffffff?text=${userInitial}`;
            const userName = commentData.userName || 'Pengguna Terautentikasi';
            const isOwner = currentUser && currentUser.uid === commentData.userId;

            const commentElement = document.createElement('div');
            commentElement.id = `comment-${docId}`;
            commentElement.className = `comment-box bg-white p-4 rounded-lg shadow-md mb-4 border border-gray-200`;

            const content = `
                <div class="flex items-start mb-2">
                    <img class="h-10 w-10 rounded-full object-cover mr-3" src="${avatarUrl}" alt="Avatar" onerror="this.onerror=null; this.src='https://placehold.co/100x100/4F46E5/ffffff?text=U'">
                    <div>
                        <p class="font-semibold text-gray-800">${userName}</p>
                        <p class="text-xs text-gray-500">${timeString}</p>
                    </div>
                </div>
                <p class="text-gray-700 ml-13">${commentData.text.replace(/\n/g, '<br>')}</p>
                <div class="flex mt-3 ml-13 space-x-4 text-sm text-gray-500">
                    <button class="hover:text-indigo-600 flex items-center" disabled>
                        <i data-feather="message-square" class="h-4 w-4 mr-1"></i> Balas
                    </button>
                    <button class="hover:text-indigo-600 flex items-center" disabled>
                        <i data-feather="heart" class="h-4 w-4 mr-1"></i> Suka (${commentData.likesCount || 0})
                    </button>
                    ${isOwner ? `
                    <button data-comment-id="${docId}" class="delete-comment-btn hover:text-red-500 flex items-center">
                        <i data-feather="trash-2" class="h-4 w-4 mr-1"></i> Hapus
                    </button>
                    ` : ''}
                </div>
            `;
            commentElement.innerHTML = content;
            feather.replace();

            if (isOwner) {
                commentElement.querySelector('.delete-comment-btn').addEventListener('click', handleDeleteComment);
            }

            return commentElement;
        }

        async function handleDeleteComment(event) {
            const commentId = event.currentTarget.getAttribute('data-comment-id');
            if (!commentId || !currentUser) return;

            // Ganti alert dengan konfirmasi UI kustom jika ini adalah aplikasi produksi.
            if (!confirm("Apakah Anda yakin ingin menghapus komentar ini?")) return; 

            try {
                const commentRef = doc(db, 'artifacts', appId, 'public', 'data', 'discussions', DISCUSSION_ID, 'comments', commentId);
                
                await updateDoc(commentRef, { 
                    isDeleted: true,
                    deletedAt: serverTimestamp()
                });

            } catch (error) {
                console.error("Gagal menghapus komentar:", error);
                document.getElementById('comment-error').textContent = "Gagal menghapus komentar: " + error.message;
                document.getElementById('comment-error').classList.remove('hidden');
            }
        }


        // --- FUNGSI MENDENGARKAN KOMENTAR REAL-TIME ---
        function listenToComments() {
            if (!db) return;
            const commentsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'discussions', DISCUSSION_ID, 'comments');
            // Catatan: Firestore memerlukan indeks untuk query dengan 'where' dan 'orderBy' yang berbeda. 
            // Kita akan mengambil semua dan melakukan filter/sorting di client untuk menghindari error index yang kompleks.
            // Namun, untuk efisiensi, kita tetap menggunakan query dasar:
            const queryRef = commentsCollectionRef; 

            const loadingEl = document.getElementById('loading-comments');
            if (loadingEl) loadingEl.classList.remove('hidden');

            onSnapshot(queryRef, snapshot => {
                commentsList.innerHTML = '';
                let commentCount = 0;
                let commentsArray = [];
                
                snapshot.forEach(doc => {
                    commentsArray.push({ id: doc.id, data: doc.data() });
                });
                
                // Client-side filtering and sorting for real-time consistency
                commentsArray = commentsArray
                    .filter(c => !c.data.isDeleted)
                    .sort((a, b) => {
                        // Sort by createdAt descending
                        const aTime = a.data.createdAt ? a.data.createdAt.toMillis() : 0;
                        const bTime = b.data.createdAt ? b.data.createdAt.toMillis() : 0;
                        return bTime - aTime;
                    });
                
                commentsArray.forEach(comment => {
                    const commentElement = renderComment(comment.data, comment.id);
                    if (commentElement) {
                        commentsList.appendChild(commentElement);
                        commentCount++;
                    }
                });
                
                commentCountDisplay.textContent = commentCount;
                totalCommentsHeader.textContent = commentCount;

                if (loadingEl) loadingEl.classList.add('hidden');

            }, error => {
                console.error("Error mendengarkan komentar:", error);
                commentsList.innerHTML = `<div class="text-red-500 p-8 text-center">Gagal memuat komentar. Pastikan Anda sudah <a href="login.html" class="font-bold underline">Login</a>.</div>`;
                if (loadingEl) loadingEl.classList.add('hidden');
            });
        }

        // --- FUNGSI INISIALISASI UTAMA (Dipanggil setelah Auth Ready) ---
        function initializeDiscussion() {
            if (!db || !currentUser) return; 

            likeButton.addEventListener('click', toggleLike);
            submitCommentButton.addEventListener('click', submitComment);
            document.getElementById('scroll-to-comment').addEventListener('click', () => {
                document.getElementById('comment-form-container').scrollIntoView({ behavior: 'smooth' });
                commentTextInput.focus();
            });

            // 1. Data Like Diskusi (Real-time)
            const discussionRef = doc(db, 'artifacts', appId, 'public', 'data', 'discussions', DISCUSSION_ID);
            onSnapshot(discussionRef, docSnapshot => { 
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    likeCountSpan.textContent = data.likesCount || 0;
                    
                    const likedBy = data.likedBy || [];
                    if (likedBy.includes(currentUser.uid)) {
                        likeButton.classList.add('text-red-500');
                        likeButton.classList.remove('text-gray-700');
                    } else {
                        likeButton.classList.remove('text-red-500');
                        likeButton.classList.add('text-gray-700');
                    }
                    likeButton.disabled = false;
                } else {
                    // Membuat dokumen diskusi jika belum ada
                    setDoc(discussionRef, { 
                        title: "Mengeksplorasi Masa Depan Kecerdasan Buatan dan Etikanya",
                        likesCount: 0,
                        likedBy: [],
                        createdAt: serverTimestamp()
                    }, { merge: true }).catch(e => console.error("Gagal membuat dokumen placeholder:", e));
                }
            }, e => console.error("Gagal mendengarkan diskusi:", e));

            // 2. Data Komentar (Real-time)
            listenToComments();
        }

        // --- TITIK MASUK UTAMA: Logika Otentikasi ---
        function setupAuthAndInitialize() {
            if (!auth) {
                 authStatusMessage.innerHTML = '<span class="text-red-500 font-bold">Error: Firebase Auth tidak tersedia. Cek konfigurasi.</span>';
                 return;
            }
            
            // Listener yang dipanggil setiap kali status auth berubah.
            onAuthStateChanged(auth, function(user) {
                currentUser = user; 
                
                if (!user) {
                    // PENGGUNA TIDAK LOGIN (HARUS DIALIHKAN)
                    authStatusMessage.innerHTML = 'Anda tidak terautentikasi. Silakan <a href="login.html" class="text-indigo-600 font-bold hover:underline">Masuk/Daftar</a> untuk berkomentar.';
                    commentTextInput.disabled = true;
                    submitCommentButton.disabled = true;
                    
                    // Coba sign in dengan token kustom jika ada (untuk pengguna Canvas)
                    if (initialAuthToken) {
                         authStatusMessage.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-indigo-600 mr-2"></div> <span class="text-gray-600">Memproses login otomatis...</span>';
                         signInWithCustomToken(auth, initialAuthToken)
                            .catch(error => {
                                console.log(`Custom token sign-in failed. Error: ${error.message}`);
                                // Jika token gagal, tetap tampilkan pesan login
                                authStatusMessage.innerHTML = 'Token kustom gagal. Silakan <a href="login.html" class="text-indigo-600 font-bold hover:underline">Masuk</a> secara manual.';
                            });
                    } else {
                        // Jika tidak ada token dan pengguna belum login, alihkan secara paksa
                        setTimeout(() => { 
                            if (window.location.pathname.indexOf('login.html') === -1) {
                                window.location.href = 'login.html'; 
                            }
                        }, 2000); 
                    }
                    return;
                }
                
                // PENGGUNA BERHASIL LOGIN (USER != NULL)
                const userName = user.displayName || `User-${user.uid.substring(0, 5)}`;
                const userInitial = userName[0].toUpperCase();
                const userAvatar = user.photoURL || `https://placehold.co/100x100/4F46E5/ffffff?text=${userInitial}`;

                document.getElementById('user-name-nav').textContent = userName;
                document.getElementById('user-avatar-nav').src = userAvatar;
                
                // Kontrol Form Komentar
                commentTextInput.disabled = false;
                submitCommentButton.disabled = false;
                authStatusMessage.innerHTML = `<span class="text-green-600">Login berhasil sebagai: <span class="font-medium">${userName}</span> (${user.uid.substring(0, 8)}...)</span>`;
                
                // Inisialisasi fungsionalitas diskusi
                initializeDiscussion();
            });

            // Jika tidak ada token kustom, dan belum ada sesi, coba signOut untuk memastikan listener onAuthStateChanged aktif
            if (!initialAuthToken && !auth.currentUser) {
                // signOut().catch(() => {}); // Tidak perlu karena onAuthStateChanged akan dipanggil dengan null
            }
        }

        if (auth) {
            setupAuthAndInitialize();
        }
    </script>
</body>
</html>

